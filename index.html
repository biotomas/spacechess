<!-- Licensed under a BSD license. See license.html for license -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>SpaceChess</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <canvas id="c" width="600" height="800"></canvas>
</body>

<script src="input.js"></script>
<script src="bullets.js"></script>
<script src="hitpoints.js"></script>
<script src="background.js"></script>
<script src="enemy.js"></script>
<script src="enemyScripts.js"></script>

<script type="module">
    import * as THREE from './libs/three.module.js';
    import { GLTFLoader } from './libs/GLTFLoader.js';
    import Collisions from './libs/collisions/Collisions.js';
    import Stats from './libs/stats.module.js';

    function main() {


        const loader = new GLTFLoader();
        const models = new Map();

        function loadModel(path, name) {
            loader.load(path, function (gltf) {
                var model = gltf.scene;
                models[name] = model;
            }, undefined, function (error) {
                console.error(error);
            });
        }

        function loadSprite(path) {
            const map = new THREE.TextureLoader().load(path);
            const material = new THREE.SpriteMaterial({ map: map });
            const sprite = new THREE.Sprite(material);
            return sprite;
        }

        const canvas = document.querySelector('#c');
        initializeInput(canvas);
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });

        const fov = 75;
        const aspect = 0.75;  // the canvas default
        const near = 0.1;
        const far = 150;
        const camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
        camera.position.z = 10;
        camera.position.y = 5;
        camera.lookAt(0, 10, 0);
        camera.position.y = -2;
        var model;

        var stats = new Stats();
        stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
        document.body.appendChild(stats.dom);

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x444444);
        setBulletSprite(loadSprite('./sprites/bullet/frame0.png'), loadSprite('./sprites/bullet/frame1.png'), 
        loadSprite('./sprites/bullet/frame2.png'), loadSprite('./sprites/bullet/frame3.png'),loadSprite('./sprites/bullet.png'), scene);
        setHPSprites(loadSprite('./sprites/HP_Bar_Version_01_Empty.png'), loadSprite('./sprites/HP_Bar_Pellet.png'), scene);

        var color = 0xFFFFFF;
        const intensity = 1;
        const light = new THREE.DirectionalLight(color, intensity);
        light.position.set(0,-3,3);
        const ambientLight = new THREE.AmbientLight(0xFFFFFF, 0.2);
        scene.add(light);
        scene.add(ambientLight);


        loadModel('models/white-pawn.glb', "pawn");
        loadModel('models/black-king.glb', "king");
        loadModel('models/blue-bishop.glb', "bishop");
        loadModel('models/red-rook.glb', "rook");
        loadModel('models/green-queen.glb', "queen");


        initializeBackground(THREE, scene);

        var modelsAdded = false;

        function render(time) {
            stats.begin();
            time *= 0.001;  // convert time to seconds
            takeInput(time);
            updateBackground(time);



            if (checkModelsLoaded()) {
                if (!modelsAdded) {
                    var pawn = models["pawn"];
                    pawn.rotation.x = Math.PI / 2;
                    pawn.position.y = -2;
                    scene.add(models["pawn"]);
                    setEnemyModels(scene, models["king"], models["queen"],models["rook"], models["bishop"]);
                    modelsAdded = true;
                }
            }

            updateBullets(time, models["pawn"]);
            updateEnemies(time);
            renderer.render(scene, camera);

            stats.end();
            requestAnimationFrame(render);
        }

        function checkModelsLoaded() {
            return (models["rook"] && models["pawn"] && models["queen"] && models["king"] && models["bishop"]);
        }

        var hpValue = 2;

        function takeInput(time) {
            var player = models["pawn"];
            if (player) {
                player.rotation.z = 0;
                if (keyIsDown(40)) {
                    // down
                    player.position.y -= 0.09;
                }
                if (keyIsDown(38)) {
                    // up
                    player.position.y += 0.09;
                }
                if (keyIsDown(37)) {
                    //left
                    player.position.x -= 0.09;
                    player.rotation.z = 0.4;
                    hpValue -= 0.1;
                }
                if (keyIsDown(39)) {
                    //right
                    hpValue += 0.1;
                    player.position.x += 0.09;
                    player.rotation.z = -0.4;
                }
                setHPValue(hpValue);
                if (keyIsDown(32)) {
                    addBullet(true, player.position.x, player.position.y + 1, 0, 1, 10, time);
                    //addBullet(true, player.position.x, player.position.y + 1, -0.4, 1, 10, time);
                    //addBullet(true, player.position.x, player.position.y + 1, 0.4, 1, 10, time);
                    finishBulletSpree(time);
                }
                //light.position.set(player.position.x, player.position.y, player.position.z + 4);

            }
        }

        requestAnimationFrame(render);

    }

    main();
</script>

</html>